---
- name: Blacklist processes nouveau 
  kernel_blacklist: name=nouveau state=present

- name: Update system with nouveau disabled
  shell: update-initramfs -u

- name: Restart server
  shell: sleep 2 && /sbin/shutdown -r now
  async: 1
  poll: 0
  ignore_errors: true

- name: Wait for server to restart
  local_action:
    module: wait_for host={{ inventory_hostname }} delay=30 timeout=120 state=started
  become: false

- name: Download latest NVIDA GRID K520 drivers
  get_url: url={{ nvidia_driver }} dest=/tmp/driver.run

- name: Install the NVIDIA GRID K520 driver
  shell: sh /tmp/driver.run -q -a -n -s